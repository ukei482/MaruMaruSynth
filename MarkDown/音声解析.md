# Analyzer 設計仕様（更新版）

## 1. 概要
音声解析モジュール `analyzer.rs` は、入力音声を解析してスペクトル情報やウェーブテーブルを生成する。
出力形式（Additive / Wavetable）は `AnalysisMode` により制御するが、解析関数自体は柔軟な引数を受け取れるよう、
モード構造から切り離して設計する。

---

## 2. 基本設計
```rust
pub struct Analyzer {
    pub sample_rate: u32,
}

impl Analyzer {
    pub fn analyze(
        &self,
        audio: &[f32],
        params: AnalysisParams, // モードとは独立した柔軟な引数
    ) -> Result<AnalysisResult, AnalyzerError> {
        match params.mode {
            AnalysisMode::Additive => self.analyze_additive(audio, &params),
            AnalysisMode::Wavetable => self.analyze_wavetable(audio, &params),
        }
    }
}
```

---

## 3. 汎用解析パラメータ構造体
```rust
pub struct AnalysisParams {
    pub mode: AnalysisMode,             // 出力方式 (Additive / Wavetable)
    pub profile: AnalysisProfile,       // 音声特性 (Natural / Percussive / Metallic / Synthetic)
    pub fft_size: usize,                // FFTサイズ
    pub hop_size: usize,                // ホップサイズ
    pub window: WindowFunction,         // 窓関数
    pub phase_strategy: Option<PhaseStrategy>, // 位相処理方式（省略時はprofileから推定）
    pub normalize: bool,                // 正規化の有無
    pub table_length: Option<usize>,    // WT用テーブル長（Additiveでは未使用）
}
```

---

## 4. 解析モード (`AnalysisMode`)
```rust
enum AnalysisMode {
    Additive,
    Wavetable,
}
```

### AdditiveResult
```rust
struct AdditiveResult {
    harmonics: Vec<Vec<Harmonic>>, // 各領域の倍音情報
    pitch_curve: Vec<f32>,         // 基本周波数推移
}
```

### WavetableResult
```rust
struct WavetableResult {
    tables: Vec<Vec<f32>>, // 各領域のウェーブテーブル
    pitch_curve: Vec<f32>, // 基本周波数推移
}
```

---

## 5. 音声特性プロファイル (`AnalysisProfile`)
解析対象の音声特性に応じて、内部パラメータ（窓関数、位相処理、FFTサイズなど）を最適化する。

```rust
enum AnalysisProfile {
    Natural,     // 環境音・水音など、連続的で非周期的
    Percussive,  // 打撃系音（鐘、打楽器など）
    Metallic,    // 金属的共鳴を持つ持続音
    Synthetic,   // 合成波・周期波形
}
```

### デフォルト設定マップ
| Profile | FFTサイズ | Hopサイズ | 窓関数 | PhaseStrategy | 備考 |
|----------|------------|------------|----------|----------------|------|
| Natural | 4096 | 1024 | Hann | Preserve | 滑らかな時間変化重視 |
| Percussive | 1024 | 256 | Blackman | AlignEnergyPeak | アタック重視 |
| Metallic | 2048 | 512 | Hamming | Hybrid(0.5) | 明瞭かつ自然 |
| Synthetic | 1024 | 256 | Rectangular | ResetZero | 周期性重視 |

---

## 6. 位相処理方式 (`PhaseStrategy`)
```rust
enum PhaseStrategy {
    Preserve,         // 元の位相保持（自然音向け）
    ResetZero,        // 位相を0に固定（周期整合）
    AlignEnergyPeak,  // 最大エネルギー点でアライン（金属音向け）
    Hybrid(f32),      // PreserveとResetZeroのブレンド (0.0〜1.0)
}
```

---

## 7. 処理フローチャート

```mermaid
flowchart TD

A[音声入力] --> B[領域指定<br>(Attack / Core / Sustain)]
B --> C[FFT解析]
C --> D[ピッチ抽出 (F0)]
D --> E[プロファイル選択<br>(AnalysisProfile)]
E --> F[FFT設定・位相戦略・ウィンドウ関数決定]
F --> G{mode}
G -->|Additive| H[加算合成解析]
G -->|Wavetable| I[ウェーブテーブル解析]
H --> J[AdditiveResult<br>(周波数・振幅・位相)]
I --> K[位相補正 (PhaseStrategy)]
K --> L[WavetableResult<br>(波形配列+F0)]
J --> M[結果保存・可視化]
L --> M
```

---

## 8. 設計上のポイント
- `Analyzer::analyze()` は **柔軟な引数構造** を採用し、モード固有パラメータも共通構造体からアクセス可能。
- `AnalysisProfile` により、解析パラメータを自動チューニング。
- 位相補正は `PhaseStrategy` により制御し、音響的破綻を防止。
- 出力結果 (`AnalysisResult`) はモード別に独立構造を持つことで拡張性を確保。

