# 音声解析モジュール 総合設計仕様（統合＋低レベル版）

> 本文書は「統合設計」と「低レベル設計」を統合した完全版である。SERUM的 DynamicPitchSync、時間領域解析、周波数領域解析（位相ボコーダ）、ノイズ除去、YIN/FFT併用F0推定、NaN補正を含む。Rust実装では各処理を `.rs` モジュールに分割して構成する。

---

## ファイル構成（Rustモジュール）
| ファイル名 | 役割 |
|-------------|------|
| `analyzer.rs` | エントリーポイント。フレーム分割、モード選択、統合制御。 |
| `preprocess.rs` | DC除去、ノイズ除去、バンドパスなどの前処理。 |
| `f0_estimator.rs` | YIN＋FFTのF0推定、NaN補正、平滑化。 |
| `mode_time.rs` | 時間領域解析：周期検出、相関整列、リサンプリング。 |
| `mode_freq.rs` | 周波数領域解析：位相ボコーダ、位相ロック、IFFT再構築。 |
| `mode_hybrid.rs` | ハイブリッド解析：低域Time＋高域Freq合成。 |
| `dynamic_pitch.rs` | DynamicPitchSync：ピッチ追従リスケーリングと位相再整列。 |
| `quality.rs` | 品質検査：周期相関・スペクトル残差・信頼度評価。 |
| `types.rs` | 共通構造体・列挙型定義（`AnalysisParams`, `AnalysisResult` など）。 |

---

## 1. パイプライン概要

1. **前処理 (`preprocess.rs`)**
   - 正規化 → DC除去 → バンドパス → スペクトルゲートノイズ除去。
2. **フレーム分割 (`analyzer.rs`)**
   - 複数解像度FFT（1024, 2048, 4096）で同時解析。
























































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































   
3. **音響指標計算**
   - Energy, Periodicity, Spectral Clarity, Harmonic Ratioを算出。
4. **F0推定 (`f0_estimator.rs`)**
   - YIN＋FFTによる並列推定、信頼度融合、NaN除去、Viterbi平滑化。
5. **モード判定 (`analyzer.rs`)**
   - periodicity閾値（0.6/0.35）でTime/Hybrid/Freqを選択。
6. **モード別処理**
   - `mode_time.rs`：周期検出・相関整列・クロスフェード。
   - `mode_freq.rs`：STFT→位相ボコーダ→位相ロック。
   - `mode_hybrid.rs`：低域Time＋高域Freqを統合。
7. **DynamicPitchSync (`dynamic_pitch.rs`)**
   - ピッチ追従リスケーリング→再検出→位相整列。
8. **テーブル生成**
   - 周期正規化＋クロスフェード結合。
9. **品質検査 (`quality.rs`)**
   - 相関値・残差・信頼度を出力。

---

## 2. 入出力仕様

### 入力
| 名称 | 型 | 内容 |
|------|----|------|
| `audio` | `Vec<f32>` | 入力波形（モノラル） |
| `sample_rate` | `u32` | サンプリングレート（推奨48kHz） |
| `AnalysisParams` | 構造体 | FFTサイズ・窓関数・モードなどの解析パラメータ |

### 出力 (`AnalysisResult`)
| フィールド | 型 | 説明 |
|-------------|----|------|
| `f0_curve` | `Vec<f32>` | 推定されたF0時系列（Hz） |
| `confidence` | `Vec<f32>` | 各F0の信頼度（0〜1） |
| `tables` | `Vec<Vec<f32>>` | 周期整合済みウェーブテーブル群 |
| `quality` | `QualityMetrics` | 平均相関・残差・NaN率などの品質指標 |

---

## 3. 前処理アルゴリズム

### 3.1 正規化
- RMS基準：目標 -10dBFS（≈0.316 RMS）。
- 計算式：`gain = target_rms / measured_rms`

### 3.2 DC除去
```rust
fn dc_remove(audio: &[f32], alpha: f32) -> Vec<f32> {
    let mut prev_x = 0.0; let mut prev_y = 0.0;
    audio.iter().map(|&x| {
        let y = x - prev_x + alpha * prev_y;
        prev_x = x; prev_y = y; y
    }).collect()
}
```

### 3.3 スペクトルゲートノイズ除去
- STFT解析（frame=1024, hop=256）。
- 無音区間でノイズ床を推定。
- 各周波数ビンで `if P(f) < N(f) + threshold_db → 0`。
- 再合成：OLAによるiSTFT。

---

## 4. F0推定アルゴリズム

### 4.1 YINアルゴリズム（自己差分法）
- 差分関数：`d(τ) = Σ(x_t - x_{t+τ})²`
- 正規化差分：`cmnd(τ) = d(τ) / (Σ_{j=1..τ} d(j)/τ)`
- 最小点の τ を周期として `F0 = sr / τ`

### 4.2 FFTハーモニック解析
- 振幅スペクトルのピーク抽出。
- 倍音比解析（f, 2f, 3f...）→ハーモニック積法（HPS）または位相整合法。
- 出力：最も一貫した倍音系列の基音周波数。

### 4.3 結果融合
- 信頼度 `C_yin`, `C_fft` に基づく加重平均。
- `F0 = (F_yin*C_yin + F_fft*C_fft) / (C_yin + C_fft)`。

### 4.4 NaN補間・平滑化
- NaN検出 → 線形またはスプライン補間。
- Confidence<0.2 の区間は欠損扱い。
- Viterbi平滑化：状態=周波数ビン、遷移コスト=Δf²。

---

## 5. モード別解析

### 5.1 時間領域 (Time)
- 周期検出：自己相関・エネルギー中心点。
- 周期間相関：隣接周期で相互相関最大点シフト。
- リサンプリング：`target_period` に合わせ sinc補間。
- クロスフェード：5%オーバーラップ、cosine窓。

### 5.2 周波数領域 (Freq)
- STFT: window=2048〜4096, hop=fft/4。
- 位相ボコーダ：`φ'(k,n) = φ(k,n-1) + Δω(k)`。
- 位相ロック：主要ピークの位相を基準に近傍ビンを同期。
- 再合成：iFFT→OLA。

### 5.3 ハイブリッド (Hybrid)
- 分割周波数 f_c = clamp(max(800, F0*5), 800, 3000)。
- 低域：Timeモード処理、高域：Freqモード処理。
- 合成：線形位相フィルタで統合。

---

## 6. DynamicPitchSync アルゴリズム
1. 平均ピッチ F_target = mean(F0(t)) を算出。
2. 時間リスケーリング：`t' = ∫(F0(t)/F_target)dt`。
3. 正規化後に再F0推定・周期境界再検出。
4. 相関または位相ロックで周期頭整列。
5. テーブル生成：均一周期長に伸縮しクロスフェード接続。

---

## 7. 品質検査 (`quality.rs`)
- 周期間相関：R > 0.85 を目標。
- スペクトル残差：原音と再構成音のエネルギー差 < 5%。
- NaN率・SNR・周期整合度をログ出力。

---

## 8. 検証・テスト
| テスト名 | 入力 | 期待結果 |
|-----------|------|------------|
| test_yin_pure_sine | 440Hz 正弦波 | F0=440±1Hz, confidence>0.95 |
| test_fft_metallic | 鐘音 | 正確なF0推定、Hybridモード選択 |
| test_dynamic_pitch | 上昇グリッサンド音 | 位相0保持、周期整合済テーブル |
| test_noise_resilience | SNR=10dB ホワイトノイズ | F0誤差<3%、NaN率<10% |

---

## 9. 実装ポリシー
- 各 `.rs` モジュールは独立テスト可能。
- 共通構造体は `types.rs` に定義し、全モジュールからimport。
- 並列化：`rayon` によるフレーム単位処理。
- FFTライブラリ：`rustfft`。
- sinc補間・iSTFTは内部関数として提供。

