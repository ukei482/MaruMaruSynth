# Oscillator 設計仕様書（Wavetable + Sampler Hybrid）

## 概要

本設計は、既存のシンセサイザー基盤（`lib.rs` で管理）に外部モジュールとして追加される **OSC部（発振器）** の構成を定義するものである。  
本OSCは「ウェーブテーブル方式」を基盤としつつ、「サンプラー的時間再生」を導入しており、音声素材の時間的特徴を保ったまま音を生成できるハイブリッドシステムである。

---

## 1. 設計方針

### 基本理念
1. **時間軸を伴うウェーブテーブル再生**
   - 通常の周期波形ループではなく、x軸（時間）方向に沿って波形を再生。
   - 音素材の「進行感」や「時間変化」を維持できる。

2. **3セクション構造（Core / Loop / Release）**
   - `Core`: 音の立ち上がり部分（アタックなど）
   - `Loop`: サスティン区間でループ再生される部分
   - `Release`: 鍵盤離鍵後に再生されるリリース部分

3. **FM合成／加算合成に対応**
   - 各OSC同士をFM変調または加算合成して多様な音色を生成。

4. **柔軟な拡張性**
   - OSCは外部モジュール化（例：`oscillator.rs`）
   - Env（3基）・LFO（5基）を想定。

---

## 2. モジュール構成

```
src/
 ├─ lib.rs                # メイン制御
 ├─ oscillator/
 │   ├─ mod.rs            # モジュール統括
 │   ├─ core.rs           # Coreセクション再生
 │   ├─ loop.rs           # Loopセクション再生
 │   ├─ release.rs        # Releaseセクション再生
 │   ├─ wavetable.rs      # 波形データ管理
 │   ├─ fm.rs             # FM合成処理
 │   └─ additive.rs       # 加算合成処理
 └─ synth.rs              # シンセサイザー統括
```

---

## 3. 構造設計

### OscillatorUnit
単一OSCを表す構造体。Core/Loop/Releaseを内部に保持。

```rust
pub struct OscillatorUnit {
    pub core: WaveSection,
    pub loop_section: WaveSection,
    pub release: WaveSection,
    pub mode: OscillatorMode, // FM or Additive
    pub sample_rate: f32,
    pub position: f32,
    pub frequency: f32,
}
```

### WaveSection
各セクション（Core/Loop/Release）の波形データを表す。

```rust
pub struct WaveSection {
    pub wavetable: Vec<Vec<f32>>,  // 各時間フレームの波形
    pub time_axis: Vec<f32>,       // フレームの対応時間
    pub crossfade: bool,           // クロスフェード有無
}
```

### OscillatorBank
複数OSCを束ねて管理する。FM／加算切替可能。

```rust
pub struct OscillatorBank {
    pub oscillators: [OscillatorUnit; 3],
    pub mix_mode: MixMode, // FM or Add
}
```

---

## 4. 再生ロジック

1. **Core再生**: 発音トリガ時に1回のみ再生。  
2. **Loop再生**: サスティン保持中にループ。クロスフェードで継ぎ目を滑らかに。  
3. **Release再生**: ノートオフ時に再生。  
4. **FMモード**: `osc2` → `osc1` に周波数変調を適用。  
5. **加算モード**: 全OSC出力を単純加算して合成。  

---

## 5. 将来的拡張

- バンドリミット版Wavetable対応（ノートごとLUT切替）
- ウェーブテーブル補間（線形／スプライン）
- フェーズリセットモード（位相同期）
- CPU軽量化のためのループキャッシュ
- 外部波形バンク対応（プリセット切替）

---

## 6. 入出力仕様

| 項目 | 型 | 説明 |
|------|----|------|
| `input_note` | MIDIノート番号 | 発音対象ノート |
| `velocity` | f32 | 発音強度 |
| `output` | Vec<f32> | 出力波形（モノラル） |
| `mode` | OscillatorMode | FMまたは加算モード |

---

## 7. 関連構造体・列挙体

```rust
pub enum OscillatorMode {
    FM,
    Additive,
}

pub enum MixMode {
    FM,
    Add,
}
```

---

## 8. 実装予定

- [ ] `OscillatorUnit::generate()` 実装
- [ ] `OscillatorBank::process()` 実装
- [ ] FM合成演算（`fm.rs`）
- [ ] Additive合成演算（`additive.rs`）
- [ ] クロスフェード再生処理（`wave_section.rs`）

---

## 9. まとめ

この設計により、サンプル素材を活用しつつウェーブテーブル音源の柔軟性を維持する「ハイブリッドシンセサイザー」の中核部を構築できる。
